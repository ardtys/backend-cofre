<?php

use App\Http\Controllers\Api\AuthController;
use App\Http\Controllers\Api\VideoController;
use App\Http\Controllers\Api\LikeController;
use App\Http\Controllers\Api\CommentController;
use App\Http\Controllers\Api\BookmarkController;
use App\Http\Controllers\Api\FollowController;
use App\Http\Controllers\Api\UserController;
use App\Http\Controllers\Api\SearchController;
use App\Http\Controllers\Api\AiController;
use App\Http\Controllers\Api\StoryController;
use App\Http\Controllers\Api\ModerationController;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Route;

// Auth routes with rate limiting to prevent brute force attacks
Route::post('/register', [AuthController::class, 'register'])->middleware('throttle:5,1'); // 5 attempts per minute
Route::post('/login', [AuthController::class, 'login'])->middleware('throttle:5,1'); // 5 attempts per minute

// TEST ONLY: AI Scan without auth (REMOVE IN PRODUCTION)
Route::post('/ai/scan-test', [AiController::class, 'scan']);

Route::middleware('auth:sanctum')->group(function () {
    // User
    Route::get('/user', function (Request $request) {
        return $request->user();
    });

    // Global Search (rate limited to prevent DoS)
    Route::get('/search', [SearchController::class, 'search'])->middleware('throttle:30,1'); // 30 searches per minute

    // Videos
    Route::get('/videos', [VideoController::class, 'index'])->middleware('throttle:60,1'); // 60 requests per minute
    Route::get('/videos/search', [VideoController::class, 'search'])->middleware('throttle:30,1'); // 30 searches per minute
    Route::get('/videos/my-videos', [VideoController::class, 'myVideos'])->middleware('throttle:60,1');
    Route::get('/videos/following', [VideoController::class, 'following'])->middleware('throttle:60,1'); // Get videos from followed users
    Route::post('/videos/upload', [VideoController::class, 'upload'])->middleware('throttle:10,60'); // 10 uploads per hour
    Route::post('/videos/{video}/view', [VideoController::class, 'recordView'])->middleware('throttle:120,1'); // 120 views per minute
    Route::delete('/videos/{video}', [VideoController::class, 'destroy'])->middleware('throttle:10,1');

    // Likes (rate limited to prevent spam)
    Route::post('/videos/{video}/like', [LikeController::class, 'toggle'])->middleware('throttle:60,1'); // 60 likes per minute

    // Comments (rate limited to prevent spam)
    Route::get('/videos/{video}/comments', [CommentController::class, 'index'])->middleware('throttle:60,1');
    Route::post('/videos/{video}/comments', [CommentController::class, 'store'])->middleware('throttle:20,1'); // 20 comments per minute
    Route::delete('/comments/{comment}', [CommentController::class, 'destroy'])->middleware('throttle:30,1');

    // Bookmarks
    Route::get('/bookmarks', [BookmarkController::class, 'index'])->middleware('throttle:60,1');
    Route::post('/videos/{video}/bookmark', [BookmarkController::class, 'toggle'])->middleware('throttle:60,1');

    // Follows (rate limited to prevent spam)
    Route::post('/users/{user}/follow', [FollowController::class, 'toggle'])->middleware('throttle:30,1'); // 30 follows per minute

    // User Profiles
    Route::get('/users/recommended', [UserController::class, 'recommendedAccounts'])->middleware('throttle:60,1'); // Get recommended accounts with videos
    Route::get('/users/{user}/profile', [UserController::class, 'show'])->middleware('throttle:60,1');
    Route::get('/users/{user}/videos', [UserController::class, 'videos'])->middleware('throttle:60,1');
    Route::put('/user/profile', [UserController::class, 'updateProfile'])->middleware('throttle:10,1'); // 10 updates per minute
    Route::post('/user/avatar', [UserController::class, 'uploadAvatar'])->middleware('throttle:10,60'); // 10 avatar uploads per hour
    Route::post('/user/change-password', [UserController::class, 'changePassword'])->middleware('throttle:5,60'); // 5 password changes per hour
    Route::delete('/user/account', [UserController::class, 'deleteAccount'])->middleware('throttle:3,60'); // 3 deletion attempts per hour

    // Share & Social Actions
    Route::post('/videos/{video}/repost', [VideoController::class, 'repost']);
    Route::post('/videos/{video}/not-interested', [VideoController::class, 'notInterested']);
    Route::post('/videos/{video}/report', [VideoController::class, 'report']);
    Route::post('/videos/{video}/share', [VideoController::class, 'shareToFriend']);

    // Friends
    Route::get('/friends', [UserController::class, 'friends']);

    // Notifications
    Route::get('/notifications', [UserController::class, 'notifications']);
    Route::post('/notifications/{notification}/read', [UserController::class, 'markNotificationAsRead']);
    Route::post('/notifications/read-all', [UserController::class, 'markAllNotificationsAsRead']);

    // AI Food Scanner (Hackathon Feature)
    // Development: 100 scans per minute (increase for testing)
    // Production: Change to throttle:20,1 (20 scans per minute)
    Route::post('/ai/scan', [AiController::class, 'scan'])->middleware('throttle:100,1'); // 100 scans per minute for development

    // Stories
    Route::get('/stories', [StoryController::class, 'index'])->middleware('throttle:60,1'); // Get all active stories
    Route::get('/stories/my-stories', [StoryController::class, 'myStories'])->middleware('throttle:60,1'); // Get user's own stories
    Route::get('/stories/archived', [StoryController::class, 'archived'])->middleware('throttle:60,1'); // Get archived stories
    Route::post('/stories/upload', [StoryController::class, 'upload'])->middleware('throttle:20,60'); // 20 uploads per hour
    Route::post('/stories/{story}/view', [StoryController::class, 'markAsViewed'])->middleware('throttle:120,1'); // Mark as viewed
    Route::get('/stories/{story}/viewers', [StoryController::class, 'viewers'])->middleware('throttle:60,1'); // Get story viewers
    Route::post('/stories/{story}/archive', [StoryController::class, 'archive'])->middleware('throttle:30,1'); // Archive story
    Route::post('/stories/{story}/unarchive', [StoryController::class, 'unarchive'])->middleware('throttle:30,1'); // Unarchive story
    Route::delete('/stories/{story}', [StoryController::class, 'destroy'])->middleware('throttle:30,1'); // Delete story

    // Admin - Video Moderation (requires admin role)
    Route::get('/admin/moderation/videos', [ModerationController::class, 'getPendingVideos'])->middleware('throttle:60,1');
    Route::post('/admin/moderation/videos/{video}/approve', [ModerationController::class, 'approveVideo'])->middleware('throttle:30,1');
    Route::post('/admin/moderation/videos/{video}/reject', [ModerationController::class, 'rejectVideo'])->middleware('throttle:30,1');
    Route::get('/admin/moderation/stats', [ModerationController::class, 'getModerationStats'])->middleware('throttle:60,1');
});
